(window.webpackJsonp=window.webpackJsonp||[]).push([[82],{wN2U:function(e,t,n){"use strict";n.r(t),n.d(t,"_frontmatter",(function(){return l})),n.d(t,"default",(function(){return p}));n("91GP"),n("rGqo"),n("yt8O"),n("Btvt"),n("RW0V"),n("q1tI");var a=n("7ljp"),r=n("013z");n("qKvR");function o(){return(o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e}).apply(this,arguments)}var l={},s={_frontmatter:l},c=r.a;function p(e){var t=e.components,n=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,["components"]);return Object(a.b)(c,o({},s,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("h3",null,"Prerequisite"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Configure the LogDNA Agent on a kubernetes cluster, you can use one of the labs in this bootcamp located ",Object(a.b)("a",o({parentName:"li"},{href:"/monitoring/logdna/#activities"}),"here"))),Object(a.b)("h2",null,"Logging library in Node.js"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"There are multiple logging libraries available for Node.js, on this example we are going to use ",Object(a.b)("a",o({parentName:"p"},{href:"https://www.npmjs.com/package/pino"}),"pino"))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"You can instrument a Node.js express web server using ",Object(a.b)("inlineCode",{parentName:"p"},"pino-http")," the example is located in GitHub ",Object(a.b)("a",o({parentName:"p"},{href:"https://github.com/ibm-cloud-architecture/learning-cloudnative-101/blob/master/examples/logging/nodejs/app.js"}),"app.js")))),Object(a.b)("pre",null,Object(a.b)("code",o({parentName:"pre"},{className:"language-javascript"}),"const express = require('express')\nconst isProduction = process.env.NODE_ENV === 'production'\nconst formatters = {\n    level(label, number) {\n        return { level: label }\n    }\n}\nconst pino = require('pino-http')({\n    prettyPrint: isProduction ? false : true,\n    level: isProduction ? 'error' : 'info',\n    formatters: formatters,\n    messageKey: 'message'\n})\nconst PORT = process.env.PORT || 8080;\n\nvar app = express()\n\napp.use(pino)\n\napp.get('/', function (req, res) {\n    req.log.info('this is a info log message')\n    res.send('Hello World')\n})\napp.get('/error', function (req, res, next) {\n    req.log.error('Internal error with request /error')\n    res.status(503).send('Internal error')\n})\n\napp.listen(PORT, () => {\n    console.log(`Listening on PORT=${PORT} and isProduction=${isProduction}`);\n})\n")),Object(a.b)("h2",null,"Deploy the sample application"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Create a namespace",Object(a.b)("pre",{parentName:"li"},Object(a.b)("code",o({parentName:"pre"},{className:"language-bash"}),"kubectl create deployment my-app --image=ibmcase/nodejs-logging-example\n")))),Object(a.b)("h2",null,"Test the application"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Expose application web service on local port 8080"),Object(a.b)("pre",{parentName:"li"},Object(a.b)("code",o({parentName:"pre"},{className:"language-shell"}),"kubectl port-forward deployment/my-app 8080:8080\n"))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Send http request to the web service"),Object(a.b)("pre",{parentName:"li"},Object(a.b)("code",o({parentName:"pre"},{className:"language-shell"}),'while true; do sleep 1; curl http://localhost:8080/error -s -w "\\n"; done\n')),Object(a.b)("p",{parentName:"li"},"  Output looks like this"),Object(a.b)("pre",{parentName:"li"},Object(a.b)("code",o({parentName:"pre"},{}),"Internal error\n"))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"Get the logs"),Object(a.b)("pre",{parentName:"li"},Object(a.b)("code",o({parentName:"pre"},{className:"language-bash"}),"kubectl logs deployment/my-app -f\n"))),Object(a.b)("li",{parentName:"ul"},Object(a.b)("p",{parentName:"li"},"The error line printend is JSON"),Object(a.b)("pre",{parentName:"li"},Object(a.b)("code",o({parentName:"pre"},{className:"language-json"}),'{"level":"error","time":1591588923197,"pid":25,"hostname":"my-app-78647889d5-nv4rt","req":{"id":2,"method":"GET","url":"/error","headers":{"host":"localhost:8080","user-agent":"curl/7.64.1","accept":"*/*"},"remoteAddress":"::ffff:127.0.0.1","remotePort":48458},"message":"Internal error with request /error"}\n')))),Object(a.b)("h2",null,"Find the JSON logs in LogDNA"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"Open the Views"),Object(a.b)("li",{parentName:"ul"},"Search for ",Object(a.b)("inlineCode",{parentName:"li"},"container:nodejs-logging-example"))),Object(a.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}},"\n      ",Object(a.b)("span",o({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"54.513888888888886%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABfElEQVQoz42SWU7DMBCGfQnEVjuJ4y0hix23pU6A0FAkyiIqBAX1hSeEuALPIHEKzsokgAQFJD6NJWfsGc/MHySlzJLEZarWkUkTkVpjR8+X82o4yHWudS6k6HVg3FsCCcFOLqZD50pXVmVljLG2b01hrTWmiKIYY+z9ASoS/ng3ybYkpPZ9D3/Pj8mfkW3wxtp6M61uHq4YZx7x/MCHFO/2A7L0iVZWN48b8/qyODpvVASoH5d+hxCC4GLCvMm4uH+677u+4Nzz/xMLpflIhf6BVVwqFUnoF3eQD/Cnka6cztWOnYC1wdDjdeOKLIklT/Ug1iMVbzERQfetBcH7BkaOCSQImORMhDAaGlIUUDq7nbvagabbu266OBuUw3o61rbQ1ugCpDNwtH86Ppgdpnme9fMoUTBd0BgxGo6G27gtpxUmFBQeCKhP8Bd6OGABZRSq3gDWYW2CF5XVTpamO+Wg3hs1tYNnwpABvAM2cRyDBvAj8s6nlAo7oOc3MGdlMNmTkX8AAAAASUVORK5CYII=')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(a.b)("img",o({parentName:"span"},{className:"gatsby-resp-image-image",alt:"json-logs-nodejs",title:"json-logs-nodejs",src:"/static/59c01581470828c33cfc5a842b84c0cc/3cbba/json-logs-nodejs.png",srcSet:["/static/59c01581470828c33cfc5a842b84c0cc/7fc1e/json-logs-nodejs.png 288w","/static/59c01581470828c33cfc5a842b84c0cc/a5df1/json-logs-nodejs.png 576w","/static/59c01581470828c33cfc5a842b84c0cc/3cbba/json-logs-nodejs.png 1152w","/static/59c01581470828c33cfc5a842b84c0cc/92c65/json-logs-nodejs.png 1216w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    "))}p.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-logging-logdna-activities-logger-nodejs-mdx-59b0b4d3d534ae8f53bc.js.map